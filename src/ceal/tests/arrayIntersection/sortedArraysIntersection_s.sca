####################################
## Intersection between two sorted arrays
##########################################################################
## See ./db.opn for input format
## result: 1, 5, 9, 12, 16, 18, 20, 25
##########################################################################


.pragma k=5 r=17 beta=8
.pragma PQ=239.251
.pragma io=ts incdir=../lib/


.mov21 header_ptr m
.inc header_ptr
.dec header_size
.mov21 header_ptr n
.inc header_ptr
.dec header_size

.mov ptr ptrA
.mov ptr ptrB
.mov ozero i
l1:
    .inc ptrB
    .inc i
.ifneq i m l1
# Now ptrA points to the start of array A, and ptrB to the start of array B.

.mov ptrB ptrBbu
.mov ozero i
outer:
    .mov i j
    .mov ptrBbu ptrB
    .add j ptrB
    inner:

        .mov21 ptrA x
        .mov21 ptrB y

        .seq x y eq
        .smul x eq tmp
        .add12 tmp res
        .inc res

        .inc j
        .inc ptrB
    .ifneq j n inner
    .inc i
    .inc ptrA
.ifneq i m outer

# Print the results
.mov resBu res
.mov ozero k
.omul m n len
loop:
    .mov21 res x
    .outd x
    # .out x
    .inc res
    .inc k
.ifneq k len loop

.halt

# variables
. header_ptr:header_start
. ptr:db_start
. res:result
. resBu:result
. i:0 j:0 k:0 len:0
. m:0 n:0 x:~0 y:~0 tmp:~0 eq:~0
. ptrA:0 ptrB:0 ptrBbu:0
. ozero:0

# data
header_start:
.include "header.opn"
header_end:
header_size: (header_end - header_start)

db_start:
.include datax "db.sec"
db_end:
db_size: (db_end - db_start)

.include "secure.lib"

. result:[200]


# int* intersectNoBranch1(int arr1[], int arr2[], int m, int n) {
#      int k = 0; 
#      int *res = calloc(m * n, sizeof(int));
#      for (int i = 0; i < m ; i++)
#           for (int j = i ; j < n ; j++) {
#               int eq = arr1[i] == arr2[j];
#               int tmp = eq * arr1[i];
#               res[k++] = arr1[i];
#           }
#      return res;
# }